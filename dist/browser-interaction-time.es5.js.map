{"version":3,"file":"browser-interaction-time.es5.js","sources":["../src/browser-interaction-time.ts"],"sourcesContent":["interface BaseTimeEllapsedCallbackData {\n  callback: (timeInMs: number) => void\n  timeInMilliseconds: number\n}\n\ntype BasicCallback = (timeInMs: number) => void\n\nexport interface TimeIntervalEllapsedCallbackData\n  extends BaseTimeEllapsedCallbackData {\n  multiplier: (time: number) => number\n}\n\nexport interface AbsoluteTimeEllapsedCallbackData\n  extends BaseTimeEllapsedCallbackData {\n  pending: boolean\n}\n\ninterface Settings {\n  timeIntervalEllapsedCallbacks?: TimeIntervalEllapsedCallbackData[]\n  absoluteTimeEllapsedCallbacks?: AbsoluteTimeEllapsedCallbackData[]\n  browserTabInactiveCallbacks?: BasicCallback[]\n  browserTabActiveCallbacks?: BasicCallback[]\n  idleTimeoutMs?: number\n  checkCallbacksIntervalMs?: number\n}\ninterface Times {\n  start: number\n  stop: number | null\n}\n\ninterface Mark {\n  time: number\n}\n\ninterface Marks {\n  [key: string]: Mark[]\n}\n\ninterface Measure {\n  name: string\n  startTime: number\n  duration: number\n}\n\ninterface Measures {\n  [key: string]: Measure[]\n}\n\nexport default class BrowserInteractionTime {\n  private running: boolean\n  private times: Times[]\n  private idle: boolean\n  private checkCallbackIntervalId?: number\n  private currentIdleTimeMs: number\n\n  private idleTimeoutMs: number\n  private checkCallbacksIntervalMs: number\n  private browserTabActiveCallbacks: BasicCallback[]\n  private browserTabInactiveCallbacks: BasicCallback[]\n  private timeIntervalEllapsedCallbacks: TimeIntervalEllapsedCallbackData[]\n  private absoluteTimeEllapsedCallbacks: AbsoluteTimeEllapsedCallbackData[]\n  private marks: Marks\n  private measures: Measures\n\n  constructor({\n    timeIntervalEllapsedCallbacks,\n    absoluteTimeEllapsedCallbacks,\n    checkCallbacksIntervalMs,\n    browserTabInactiveCallbacks,\n    browserTabActiveCallbacks,\n    idleTimeoutMs\n  }: Settings) {\n    this.running = false\n    this.times = []\n    this.idle = false\n    this.currentIdleTimeMs = 0\n    this.marks = {}\n    this.measures = {}\n    this.browserTabActiveCallbacks = browserTabActiveCallbacks || []\n    this.browserTabInactiveCallbacks = browserTabInactiveCallbacks || []\n    this.checkCallbacksIntervalMs = checkCallbacksIntervalMs || 100\n    this.idleTimeoutMs = idleTimeoutMs || 30000 // 30s\n    this.timeIntervalEllapsedCallbacks = timeIntervalEllapsedCallbacks || []\n    this.absoluteTimeEllapsedCallbacks = absoluteTimeEllapsedCallbacks || []\n\n    this.registerEventListeners()\n  }\n\n  private onBrowserTabInactive = (event: Event) => {\n    // if running pause timer\n    if (this.isRunning()) {\n      this.stopTimer()\n    }\n\n    this.browserTabInactiveCallbacks.forEach(fn =>\n      fn(this.getTimeInMilliseconds())\n    )\n  }\n\n  private onBrowserTabActive = (event: Event) => {\n    // if not running start timer\n    if (!this.isRunning()) {\n      this.startTimer()\n    }\n\n    this.browserTabActiveCallbacks.forEach(fn =>\n      fn(this.getTimeInMilliseconds())\n    )\n  }\n\n  private onTimePassed = () => {\n    // check all callbacks time and if passed execute callback\n    this.absoluteTimeEllapsedCallbacks.forEach(\n      ({ callback, pending, timeInMilliseconds }, index) => {\n        if (!pending && timeInMilliseconds <= this.getTimeInMilliseconds()) {\n          callback(this.getTimeInMilliseconds())\n          this.absoluteTimeEllapsedCallbacks[index].pending = true\n        }\n      }\n    )\n\n    this.timeIntervalEllapsedCallbacks.forEach(\n      ({ callback, timeInMilliseconds, multiplier }, index) => {\n        if (timeInMilliseconds <= this.getTimeInMilliseconds()) {\n          callback(this.getTimeInMilliseconds())\n          this.timeIntervalEllapsedCallbacks[\n            index\n          ].timeInMilliseconds = multiplier(timeInMilliseconds)\n        }\n      }\n    )\n\n    if (this.currentIdleTimeMs >= this.idleTimeoutMs && this.isRunning()) {\n      this.idle = true\n      this.stopTimer()\n    } else {\n      this.currentIdleTimeMs += this.checkCallbacksIntervalMs\n    }\n  }\n\n  private resetIdleCountdown = () => {\n    if (this.idle) {\n      this.startTimer()\n    }\n    this.idle = false\n    this.currentIdleTimeMs = 0\n  }\n\n  private registerEventListeners = () => {\n    const eventlistenerOptions = { passive: true }\n\n    window.addEventListener('blur', this.onBrowserTabInactive)\n    window.addEventListener('focus', this.onBrowserTabActive)\n    window.addEventListener(\n      'scroll',\n      this.resetIdleCountdown,\n      eventlistenerOptions\n    )\n    document.addEventListener(\n      'mousemove',\n      this.resetIdleCountdown,\n      eventlistenerOptions\n    )\n    document.addEventListener(\n      'keyup',\n      this.resetIdleCountdown,\n      eventlistenerOptions\n    )\n    document.addEventListener(\n      'touchstart',\n      this.resetIdleCountdown,\n      eventlistenerOptions\n    )\n  }\n\n  private unregisterEventListeners = () => {\n    window.removeEventListener('blur', this.onBrowserTabInactive)\n    window.removeEventListener('focus', this.onBrowserTabActive)\n    window.removeEventListener('scroll', this.resetIdleCountdown)\n    document.removeEventListener('mousemove', this.resetIdleCountdown)\n    document.removeEventListener('keyup', this.resetIdleCountdown)\n    document.removeEventListener('touchstart', this.resetIdleCountdown)\n  }\n\n  private checkCallbacksOnInterval = () => {\n    this.checkCallbackIntervalId = window.setInterval(() => {\n      this.onTimePassed()\n    }, this.checkCallbacksIntervalMs)\n  }\n\n  public startTimer = () => {\n    if (!this.checkCallbackIntervalId) {\n      this.checkCallbacksOnInterval()\n    }\n    const last = this.times[this.times.length - 1]\n    if (last && last.stop === null) {\n      return\n    }\n    this.times.push({\n      start: performance.now(),\n      stop: null\n    })\n    this.running = true\n  }\n\n  public stopTimer = () => {\n    if (!this.times.length) {\n      return\n    }\n    this.times[this.times.length - 1].stop = performance.now()\n    this.running = false\n  }\n\n  public addTimeIntervalEllapsedCallback = (\n    timeIntervalEllapsedCallback: TimeIntervalEllapsedCallbackData\n  ) => {\n    this.timeIntervalEllapsedCallbacks.push(timeIntervalEllapsedCallback)\n  }\n\n  public addAbsoluteTimeEllapsedCallback = (\n    absoluteTimeEllapsedCallback: AbsoluteTimeEllapsedCallbackData\n  ) => {\n    this.absoluteTimeEllapsedCallbacks.push(absoluteTimeEllapsedCallback)\n  }\n\n  public addBrowserTabInactiveCallback = (\n    browserTabInactiveCallback: BasicCallback\n  ) => {\n    this.browserTabInactiveCallbacks.push(browserTabInactiveCallback)\n  }\n\n  public addBrowserTabActiveCallback = (\n    browserTabActiveCallback: BasicCallback\n  ) => {\n    this.browserTabActiveCallbacks.push(browserTabActiveCallback)\n  }\n\n  public getTimeInMilliseconds = (): number => {\n    return this.times.reduce((acc, current) => {\n      if (current.stop) {\n        acc = acc + (current.stop - current.start)\n      } else {\n        acc = acc + (performance.now() - current.start)\n      }\n      return acc\n    }, 0)\n  }\n\n  public isRunning = () => {\n    return this.running\n  }\n\n  public reset = () => {\n    this.times = []\n  }\n\n  public destroy = () => {\n    this.unregisterEventListeners()\n    if (this.checkCallbackIntervalId) {\n      window.clearInterval(this.checkCallbackIntervalId)\n    }\n  }\n\n  public mark(key: string) {\n    if (!this.marks[key]) {\n      this.marks[key] = []\n    }\n    this.marks[key].push({ time: this.getTimeInMilliseconds() })\n  }\n\n  public getMarks(name: string) {\n    if (this.marks[name].length < 1) {\n      return\n    }\n\n    return this.marks[name]\n  }\n\n  public measure(name: string, startMarkName: string, endMarkName: string) {\n    const startMarks = this.marks[startMarkName]\n    const startMark = startMarks[startMarks.length - 1]\n    const endMarks = this.marks[endMarkName]\n    const endMark = endMarks[endMarks.length - 1]\n\n    if (!this.measures[name]) {\n      this.measures[name] = []\n    }\n\n    this.measures[name].push({\n      name,\n      startTime: startMark.time,\n      duration: endMark.time - startMark.time\n    })\n  }\n\n  public getMeasures(name: string) {\n    if (!this.measures[name] && this.measures[name].length < 1) {\n      return\n    }\n\n    return this.measures[name]\n  }\n}\n"],"names":[],"mappings":"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"}