{"version":3,"file":"browser-interaction-time.umd.js","sources":["../src/browser-interaction-time.ts"],"sourcesContent":["type NoArgNoReturn = () => void\n\ninterface BaseTimeEllapsedCallback {\n  callback: () => void\n  timeInMilliseconds: number\n}\n\nexport interface TimeIntervalEllapsedCallback extends BaseTimeEllapsedCallback {\n  multiplier: (time: number) => number\n}\n\nexport interface AbsoluteTimeEllapsedCallback extends BaseTimeEllapsedCallback {\n  pending: boolean\n}\n\ninterface Settings {\n  timeIntervalEllapsedCallbacks: TimeIntervalEllapsedCallback[]\n  absoluteTimeEllapsedCallbacks: AbsoluteTimeEllapsedCallback[]\n  userLeftCallbacks: NoArgNoReturn[]\n  userReturnCallbacks: NoArgNoReturn[]\n  pauseOnMouseMovement: boolean\n  pauseOnScroll: boolean\n  idleTimeoutMs: number\n  checkCallbacksIntervalMs: number\n}\n\nexport interface DomApi {\n  addEventListener: (type: string, fn: Function, options?: any ) => void\n  removeEventListener: (type: string, fn: Function, options?: any) => void\n  setInterval: (fn: Function, interval: number) => number\n  clearInterval: (id: number) => void\n  hidden: boolean\n}\n\ninterface Times {\n  start: Date\n  stop: Date | null\n}\nexport default class BrowserInteractionTime {\n  private times: Times[]\n  private intervalId?: number\n  private running: boolean\n  private idleTimeoutMs: number\n  private currentIdleTimeMs: number\n  private checkCallbacksIntervalMs: number\n  private idle: boolean\n  private checkCallbackIntervalId?: number\n  private userReturnCallbacks: NoArgNoReturn[]\n  private userLeftCallbacks: NoArgNoReturn[]\n  private timeIntervalEllapsedCallbacks: TimeIntervalEllapsedCallback[]\n  private absoluteTimeEllapsedCallbacks: AbsoluteTimeEllapsedCallback[]\n  private domApi: DomApi\n  \n  constructor({\n    timeIntervalEllapsedCallbacks,\n    absoluteTimeEllapsedCallbacks,\n    checkCallbacksIntervalMs,\n    userLeftCallbacks,\n    userReturnCallbacks,\n    idleTimeoutMs\n  }: Settings, domApi: DomApi) {\n    this.userReturnCallbacks = userReturnCallbacks\n    this.userLeftCallbacks = userLeftCallbacks\n    this.times = []\n    this.idle = false\n    this.currentIdleTimeMs = 0\n    this.checkCallbacksIntervalMs = checkCallbacksIntervalMs || 250\n    this.idleTimeoutMs = idleTimeoutMs || 30000 // 30s\n    this.running = false\n    this.timeIntervalEllapsedCallbacks = timeIntervalEllapsedCallbacks\n    this.absoluteTimeEllapsedCallbacks = absoluteTimeEllapsedCallbacks\n    this.domApi = domApi\n    this.registerEventListeners()\n    this.startTimer()\n    this.checkCallbacksOnInterval()\n  }\n\n  private triggerUserLeftPage = () => {\n    // if running pause timer\n    if (this.isRunning) {\n      this.stopTimer()\n    }\n    this.userLeftCallbacks.forEach(fn => fn())\n  }\n\n  private triggerUserHasReturned = () => {\n    // if not running start timer\n    if (!this.isRunning) {\n      this.startTimer()\n    }\n    this.userReturnCallbacks.forEach(fn => fn())\n  }\n\n  private onTimePassed = () => {\n    // check all callbacks time and if passed execute callback\n    this.absoluteTimeEllapsedCallbacks.forEach(\n      ({ callback, pending, timeInMilliseconds }, index) => {\n        if (pending && timeInMilliseconds >= this.getTimeInMilliseconds()) {\n          callback()\n          this.absoluteTimeEllapsedCallbacks[index].pending = true\n        }\n      }\n    );\n\n    this.timeIntervalEllapsedCallbacks.forEach(({ callback, timeInMilliseconds, multiplier}, index) =>  {\n      if (timeInMilliseconds >= this.getTimeInMilliseconds()) {\n        callback()\n        this.timeIntervalEllapsedCallbacks[index].timeInMilliseconds = multiplier(timeInMilliseconds)\n      }\n    })\n  }\n\n  private resetIdleCountdown = () => {\n    this.idle = false\n    this.currentIdleTimeMs = 0\n  }\n\n  private visibilityChangeHandler = () => {\n    if (this.domApi.hidden) {\n      this.triggerUserLeftPage()\n    } else {\n      this.triggerUserHasReturned()\n    }\n  }\n\n  private registerEventListeners = () => {\n    this.domApi.addEventListener(\n      'visibilitychange',\n      this.visibilityChangeHandler,\n      false\n    )\n\n    this.domApi.addEventListener('blur', this.triggerUserLeftPage)\n    this.domApi.addEventListener('focus', this.triggerUserHasReturned)\n    this.domApi.addEventListener('scroll', this.resetIdleCountdown)\n    this.domApi.addEventListener('mousemove', this.resetIdleCountdown)\n    this.domApi.addEventListener('keyup', this.resetIdleCountdown)\n    this.domApi.addEventListener('touchstart', this.resetIdleCountdown)\n  }\n\n  private unregisterEventListeners = () => {\n    this.domApi.removeEventListener(\n      'visibilitychange',\n      this.visibilityChangeHandler,\n      false\n    )\n\n    this.domApi.removeEventListener('blur', this.triggerUserLeftPage)\n    this.domApi.removeEventListener('focus', this.triggerUserHasReturned)\n    this.domApi.removeEventListener('scroll', this.resetIdleCountdown)\n    this.domApi.removeEventListener('mousemove', this.resetIdleCountdown)\n    this.domApi.removeEventListener('keyup', this.resetIdleCountdown)\n    this.domApi.removeEventListener('touchstart', this.resetIdleCountdown)\n  }\n\n  private checkCallbacksOnInterval = () => {\n    this.checkCallbackIntervalId = this.domApi.setInterval(() => {\n      this.onTimePassed()\n    }, this.checkCallbacksIntervalMs)\n  }\n\n  public startTimer = () => {\n    const last = this.times[this.times.length - 1]\n    if (last && last.start && last.stop === undefined) {\n      return\n    }\n    this.times.push({\n      start: new Date(),\n      stop: null\n    })\n    this.running = true\n  }\n\n  public stopTimer = () => {\n    if (!this.times.length) {\n      return\n    }\n    this.times[this.times.length - 1].stop = new Date()\n    this.running = false\n  }\n\n  public addTimeIntervalEllapsedCallback = (\n    timeIntervalEllapsedCallback: TimeIntervalEllapsedCallback\n  ) => {\n    this.timeIntervalEllapsedCallbacks.push(timeIntervalEllapsedCallback)\n  }\n\n  public addAbsoluteTimeEllapsedCallback = (\n    absoluteTimeEllapsedCallback: AbsoluteTimeEllapsedCallback\n  ) => {\n    this.absoluteTimeEllapsedCallbacks.push(absoluteTimeEllapsedCallback)\n  }\n\n  public addUserLeftCallback = (\n    userLeftCallback: NoArgNoReturn\n  ) => {\n    this.userLeftCallbacks.push(userLeftCallback)\n  }\n\n  public addUserReturnCallback = (\n    userReturnCallback: NoArgNoReturn\n  ) => {\n    this.userReturnCallbacks.push(userReturnCallback)\n  }\n\n  public getTimeInMilliseconds = (): number => {\n    return this.times.reduce((acc, current) => {\n      if (current.stop && current.start) {\n        return (\n          acc +\n          (current.stop.getMilliseconds() - current.start.getMilliseconds())\n        )\n      }\n      return acc\n    }, 0)\n    return 0\n  }\n\n  public isRunning = () => {\n    return this.isRunning\n  }\n\n  public resetTime = () => {\n    this.times = []\n  }\n\n  public destroy = () => {\n    this.unregisterEventListeners()\n    if (this.checkCallbackIntervalId) {\n      this.domApi.clearInterval(this.checkCallbackIntervalId)\n    }\n  }\n}\n"],"names":[],"mappings":"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"}